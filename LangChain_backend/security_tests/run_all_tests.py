"""
Master Security Test Suite
TÃ¼m testleri otomatik Ã§alÄ±ÅŸtÄ±rÄ±r ve rapor oluÅŸturur
"""

import subprocess
import json
from datetime import datetime
from colorama import init, Fore, Style

init()

def run_test_script(script_name, description):
    """Test scriptini Ã§alÄ±ÅŸtÄ±r ve sonucu dÃ¶ndÃ¼r"""
    print(f"\n{Fore.CYAN}{'=' * 70}{Style.RESET_ALL}")
    print(f"{Fore.CYAN}Running: {description}{Style.RESET_ALL}")
    print(f"{Fore.CYAN}{'=' * 70}{Style.RESET_ALL}\n")
    
    try:
        result = subprocess.run(
            ['python', script_name],
            capture_output=True,
            text=True,
            timeout=120,
            cwd=r'c:\Users\Esisya\.gemini\antigravity\scratch\LangChain_backend\security_tests'
        )
        
        return {
            'name': description,
            'script': script_name,
            'status': 'COMPLETED' if result.returncode == 0 else 'FAILED',
            'output': result.stdout + result.stderr
        }
    except subprocess.TimeoutExpired:
        return {
            'name': description,
            'script': script_name,
            'status': 'TIMEOUT',
            'output': 'Test exceeded 120 seconds'
        }
    except Exception as e:
        return {
            'name': description,
            'script': script_name,
            'status': 'ERROR',
            'output': str(e)
        }

def generate_final_report(results):
    """Nihai raporu oluÅŸtur"""
    
    report = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 LUMORA AI CHATBOT - SECURITY AUDIT REPORT           â•‘
â•‘                      Comprehensive Penetration Test                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Report Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Target: Lumora AI Chatbot (Backend + Frontend)
Backend: http://localhost:8000
Frontend: http://localhost:3000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EXECUTIVE SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Total Tests Run: {len(results)}
Completed: {sum(1 for r in results if r['status'] == 'COMPLETED')}
Failed: {sum(1 for r in results if r['status'] != 'COMPLETED')}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TEST RESULTS SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    
    for i, result in enumerate(results, 1):
        status_symbol = "âœ…" if result['status'] == 'COMPLETED' else "âŒ"
        report += f"\n[{i}] {status_symbol} {result['name']}\n"
        report += f"    Script: {result['script']}\n"
        report += f"    Status: {result['status']}\n"
        report += f"    {'â”€' * 66}\n"
    
    report += f"\n{'â•' * 70}\n"
    report += f"DETAILED TEST OUTPUTS\n"
    report += f"{'â•' * 70}\n\n"
    
    for result in results:
        report += f"\n{'â–ˆ' * 70}\n"
        report += f"TEST: {result['name']}\n"
        report += f"{'â–ˆ' * 70}\n\n"
        report += result['output']
        report += f"\n\n"
    
    report += f"\n{'â•' * 70}\n"
    report += f"END OF REPORT\n"
    report += f"{'â•' * 70}\n"
    report += f"\nGenerated by: Antigravity Security Assessment Tool\n"
    report += f"Report saved: FINAL_SECURITY_REPORT_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt\n"
    
    return report

if __name__ == "__main__":
    print(f"{Fore.RED}")
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘          LUMORA SECURITY AUDIT - AUTOMATED TEST SUITE           â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print(f"{Style.RESET_ALL}\n")
    
    tests = [
        ('security_test.py', 'General Security Scan'),
        ('rate_limiting_test.py', 'Rate Limiting & Brute Force Test'),
        ('jwt_hijacking_test.py', 'JWT Token Security Test'),
        ('quick_xss_test.py', 'XSS Vulnerability Test'),
        ('server_health_check.py', 'Server Health Baseline'),
    ]
    
    results = []
    
    for script, description in tests:
        result = run_test_script(script, description)
        results.append(result)
        
        if result['status'] == 'COMPLETED':
            print(f"{Fore.GREEN}âœ… {description} - PASSED{Style.RESET_ALL}")
        else:
            print(f"{Fore.RED}âŒ {description} - {result['status']}{Style.RESET_ALL}")
    
    # Generate report
    print(f"\n{Fore.YELLOW}Generating final report...{Style.RESET_ALL}\n")
    
    final_report = generate_final_report(results)
    
    # Save to file
    filename = f"FINAL_SECURITY_REPORT_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(final_report)
    
    print(f"{Fore.GREEN}âœ… Report saved: {filename}{Style.RESET_ALL}\n")
    
    # Summary
    print(f"{Fore.CYAN}{'=' * 70}{Style.RESET_ALL}")
    print(f"{Fore.CYAN}FINAL SUMMARY{Style.RESET_ALL}")
    print(f"{Fore.CYAN}{'=' * 70}{Style.RESET_ALL}\n")
    
    completed = sum(1 for r in results if r['status'] == 'COMPLETED')
    print(f"Total Tests: {len(results)}")
    print(f"Completed: {Fore.GREEN}{completed}{Style.RESET_ALL}")
    print(f"Failed: {Fore.RED}{len(results) - completed}{Style.RESET_ALL}")
    print(f"Success Rate: {(completed/len(results))*100:.1f}%\n")
    
    print(f"ğŸ“„ Full report: {filename}\n")
